from random import randint
points = {
        1 : 1,
        2 : 3,
        3 : 6,
        4 : 10,
        5 : 15,
        6 : 21,
        7 : 28,
        8 : 36,
        9 : 45,
        10: 55,
        11: 66,
        12: 75
    }
 

#if line is locked, deletes the dice colour name
def remove_dice(couleur):
    if is_locked() :
        del liste_couleur[couleur]


# renvoie une liste contenant les valeurs des dés
def dice_values():
    """
    None -> list
    Fonction qui renvoie une liste contenant les valeurs des dés
    """
    valeurs = [randint(1, 6) for i in range(len(liste_couleur))]
    return valeurs


def combine_whites(des_valeurs):
    """
    retourne la somme de dés blancs
    """
    return des_valeurs[-2] + des_valeurs[-1]


def combine_w_colour(des_valeurs):
    """
    None -> Int
    Fonction qui renvoie la combinaison d'un dé de couleur et un dé blanc
    """
    somme = 0
    
    while True :
        couleur = input("Tapez la couleur de dé que vous voulez parmi {} qui valent"
                    " respectivement {} : ".format(liste_couleur[:-2], des_valeurs[:-2]))
        
        if couleur.lower() in liste_couleur[:-2] :
            i = liste_couleur.index(couleur)
            somme += des_valeurs[i]
            break
        print("[ERREUR] Il n'existe cette couleur de dé. Recommencez.")
    
    print(liste_couleur[-2:])
    while True :
        blanc = input("Vous voulez additionner cette couleur avec lequel des dés blancs ? {} qui valent {} : ".format(liste_couleur[-2:], des_valeurs[-2:]))
        
        if blanc.lower() in liste_couleur[-2:] :
            i = liste_couleur.index(blanc)
            somme += des_valeurs[i]
            break
        print("[ERREUR] Il n'existe cette couleur de dé. Recommencez.")
    
    return somme


# Convert the color into a number
def indice_couleur(couleur):
    """
    Str -> Int 
    Fonction retournant l'indice de la couleur.
    """

    if couleur.lower() == "rouge" or couleur.lower() == "r" :
        return 0
    
    elif couleur.lower() == "jaune" or couleur.lower() == "j":
        return 1
    
    elif couleur.lower() == "bleu" or couleur.lower() == "b":
        return 2
    
    # Ligne est vert
    return 3


# Check if the number can be cross on a line.
def verif_num_supp(fiche_player, couleur, n):
    """
    List x Int x Int -> Bool
    Fonction retournant True si la valeur est plus grande que la dernière valeur de la ligne, False sinon. 
    """

    if fiche_player[couleur] == []:
        return True

    # Ligne jaune et rouge.
    if 0 <= couleur <= 1:
        if fiche_player[couleur][-1] < n:
            return True
        return False

    # Ligne bleue et verte.
    if fiche_player[couleur][-1] > n:
        return True
    return False
    

# Cross number on the line
def ajoute_numero(fiche_player: list, couleur, n):
    """
    List x Int x Int -> None
    Processus qui permet d'ajouter le numéro coché sur la fiche
    """
    fiche_player[couleur].append(n)


# Check if the line is locked or not (+5 crossed numbers and lock number is crossed)
def is_locked(fiche_player, couleur):
    """
    List, Int -> Bool
    Fonction retournant True si la ligne comporte 5 cases cochées et le dernier numéro coché.
    """

    if 0 <= couleur <= 1:
        if len(fiche_player[couleur]) >= 5 and 12 in fiche_player[couleur]:
            return True

    if len(fiche_player[couleur]) >= 5 and 2 in fiche_player[couleur]:
        return True


def place_x(player_fiche, dice_value, active_colour=0) :
    print("Entrez une couleur de ligne pour cocher le numéro: ")
    if active_colour in liste_couleur :
        if verif_num_supp(player_fiche, active_colour, dice_value):
            ajoute_numero(player_fiche, active_colour, dice_value)
            return player_fiche

    ask = input(">")

    if ask.lower() in ["rouge", "r", "vert", "v", "jaune", "j", "bleu", "b"]:
        couleur = indice_couleur(ask)

        if verif_num_supp(player_fiche, couleur, dice_value):
            ajoute_numero(player_fiche, couleur, dice_value)
            return player_fiche

        else:
            print(f"{dice_value} ne peut pas être coché sur cette ligne. Recommencez.")
            return place_x(player_fiche, dice_value)
    else:
        print("[Commande invalide]")
        return place_x(player_fiche, dice_value)


def play(player_name, player_fiche, dice, active_colour=0, skip=0, lock=False) :
    if lock == False :
        print(f"{player_name} voulez-vous cocher la somme des dés {dice} (oui/pass) ? ")
        ask = input(">")

        if ask.lower() == "o" or ask.lower() == "oui" :
            player_fiche = place_x(player_fiche, dice)

        elif ask.lower() == "pass" or ask.lower() == "p":
            skip += 1
    
        else:
            print("[Commande invalide]")
            return play(player_name, player_fiche, dice, skip, False)
    
    # quand lock est True
    else :
        player_fiche = place_x(player_fiche, dice, active_colour)

    if player_name == active_player and not(lock):
        #affiche des dés
        print("Vous êtes le joueur actif. Vous pouvez combiner un dé blanc et un dé coloré. Les dés :")
        for k in range(len(liste_couleur)) :
            print(f"{liste_couleur[k]} : {des_valeurs[k]}")
        
        c = True
        while c :
            combine = input("Voulez-vous combiner des dés (oui/pass) ? ")
        
            if combine.lower() == "o" or combine.lower() == "oui" :
                dice_value = combine_w_colour(des_valeurs)
                play(player_name, player_fiche, dice_value, skip, lock = True)
                c = False

            elif combine.lower() == "pass" or combine.lower() == "p":
                skip += 1
                c = False
            
            else:
                print("[Commande invalide]")

    if skip == 2:
        player_fiche[-1] += 1
        print(f"Vous avez obtenu un pénalité. \nVous avez {player_fiche[-1]} pénalité.")
    
    return player_fiche


# End/Win conditions
def check_end(player_fiche, player_name, couleurs):
    #if someone has 4 penalties
    if player_fiche[-1] == 4 :
        print(f"{player_name} a 4 pénalité.")
        return True
    
    #if 2 lines are locked <==> 2 dices are removed
    if len(couleurs) == 4:
        print("Vous avez enlevez le deuxieme dé coloré.")
        return True
    
    return False


#calculates points and tells who is the winner
#normally the fiche_joueurs should be in playing order so it matches the names in order
def who_won(fiche_joueurs, player_names):
    """
    Compte des points et affiche le gagnant
    """
    print("Le jeu est terminé. \nLes points sont calculés... \n")
    
    points_joueurs = [0 for i in range(len(fiche_joueurs))]

    for player in range(len(fiche_joueurs)) :
        # add points for each colour
        for couleur in range(4) :
            nombre_x = len(fiche_joueurs[player][couleur])
            points_joueurs[player] += points[nombre_x]
            
        # minus points for skips (penalty)
        points_joueurs[player] -= (fiche_joueurs[player][-1] * 5)
    
    winner_index = points_joueurs.index(max(points_joueurs))
    print(f"Vous avez gagné, {player_names[winner_index]} avec {max(points_joueurs)} points.")
    

## Notes et problèmes ##

# Les éléments primaires sont: la fiche du joueur, les dés (2w, 1r, 1g, 1b, 1y), 
# Les éléments secondaires sont: les conditions d'arrêt, cocher un case de la fiche, les conditions pour pouvoir cocher une case, sélection de personnage, tour par tour, pénalités, active_player

# fiche_player: liste d'élément, chaque élément correspond à une ligne de la fiche écrit en str, les str sont les numéros cochés enregistrés en base 16. La pénalité (int) est le dernier élément de la liste. 

# [A RE-CODER] indice_couleur: will be probably troublesome when removing a dice
# [A CODER] affichage des fiches
# [A EDITER] affichage des dés
##



#setup
dice = ["⚀", "⚁", "⚂", "⚃", "⚄", "⚅"]
liste_couleur = ["rouge", "jaune", "bleu", "vert", "blanc1", "blanc2"]


def game_no_bot():
    global active_player, des_valeurs

    # [Initialisation provisoire]
    fiche_joueurs = [[[], [], [], [], 0] for i in range(4)]
    ordre_joueur = ["moi", "moi2", "moi3", "eris"]

    # Start
    running = True
    while running:
        for player_number, active_player in enumerate(ordre_joueur):

            # Set up player_fiche and skip
            player_fiche = fiche_joueurs[player_number]

            # Trow dice
            print(f"[Tour de {active_player}]")
            input("Tapez ENTER pour lancer le dé : ")
            des_valeurs = dice_values()
            
            # Affiche des dés
            print("Les dés :")
            for k in range(len(liste_couleur)) :
                print(f"{liste_couleur[k]} : {des_valeurs[k]}")
        
            # Somme des blancs
            blancs = combine_whites(des_valeurs)
            print(f"\nLa somme de dés blancs: {blancs}\n")

            # Passive players
            for player_num, player in enumerate(ordre_joueur):
                    if player != active_player :
                        fiche = play(player, fiche_joueurs[player_num], blancs)
                        print(f"{player} : {fiche}\n")
            player_fiche = play(active_player, player_fiche, blancs)
            print(f"active player : {player_fiche}\n")
            

game_no_bot()
